{% extends "app/layout.html" %}

{% load staticfiles %}

{% block styles %}
{% endblock %}

{% block content %}
<div class="container">
    <h4>{{ session.module }}</h4>
    <h5>{{ session }}</h5>
    {% verbatim %}
    <div id="app">
        <v-app id="inspire">
            <v-list three-line subheader>
                <v-subheader>Attendance Sheet</v-subheader>
                <v-list-tile v-for="s in students" href="javascript:;" :key="s.student_id">
                    <v-list-tile-action>
                        <v-checkbox v-model="s.presented" readonly></v-checkbox>
                    </v-list-tile-action>
                    <v-list-tile-content @click="s.presented = !s.presented">
                        <v-list-tile-title>{{ s.first_name }} {{ s.last_name }}</v-list-tile-title>
                        <v-list-tile-sub-title class="text--primary">{{ s.student_id }}</v-list-tile-sub-title>
                        <v-list-tile-sub-title>{{ s.comment }}</v-list-tile-sub-title>
                    </v-list-tile-content>
                </v-list-tile>
            </v-list>
        </v-app>
    </div>
    {% endverbatim %}
    <button type="button" class="btn btn-primary" id="save">Save</button>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'module/scripts/js.cookie.js' %}"></script>

<script>
    var students_data = {{ attendees|safe }};
    var attendance_sheet = new Vue({
        el: '#app',
        data() {
            return {
                students: students_data
            }
        }
    });

    $('#save').click(function() {
        var postUrl = "{% url 'session_taking_attendance' session.pk %}";

        var xhr = new XMLHttpRequest();
        xhr.open('POST', postUrl, true);
        xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
        xhr.setRequestHeader('X-CSRFToken', Cookies.get('csrftoken'));
        xhr.onloadend = function() {
            location.reload();
        };

        var attendance = attendance_sheet.students;
        var upload = {};
        for (var i = 0; i < attendance.length; ++i) {
            upload[attendance[i].student_id] = attendance[i];
        }

        var payload = JSON.stringify(upload);
        xhr.send(payload);
    });
</script>
{% endblock %}